var H=Object.defineProperty;var J=(s,o,l)=>o in s?H(s,o,{enumerable:!0,configurable:!0,writable:!0,value:l}):s[o]=l;var C=(s,o,l)=>(J(s,typeof o!="symbol"?o+"":o,l),l);import{j as t}from"./RequirementCard-DEdD30eg.js";import{r as i}from"./index-RYns6xqu.js";import{c as K}from"./ReactAppend-vpV7VTGG.js";import{B as Q}from"./Base-4XzyVO90.js";import{C as X}from"./CreateReactScript-BuKYEKxn.js";import{T as Z}from"./Table-CyG7yWBs.js";import{M as ee}from"./Modal-1_SBF_XS.js";import{I as b}from"./InputFormGroup-B7mKwzkx.js";import{R as E}from"./ReactAppend-DPXaoPQG.js";import{D as W}from"./DxButton-CsjWvhyj.js";import{S as ne}from"./SwitchFormGroup-SB6Qzl6-.js";import{I as te}from"./ImageFormGroup-Csvj9Cte.js";import{S as x}from"./sweetalert2.all-DJo0UVK6.js";import{B as re}from"./Results-BBVbNL2k.js";import{r as p}from"./DxBox-DZgBbgD6.js";import{T as ie}from"./TextareaFormGroup-B4XWcpu0.js";import{S as q}from"./SelectFormGroup-CVn9r_7Q.js";import"./index-CXU7o9CY.js";import"./tippy-react.esm-DYFqe69e.js";/* empty css              */import"./Logout-BlWggqgx.js";import"./main-Y8JAyXgE.js";import"./___vite-browser-external_commonjs-proxy-DbMF7jdq.js";import"./index.esm-zkRd-kwu.js";import"./axios-B4uVmeYG.js";import"./useTranslation-CZbMeh78.js";import"./Filter-CpekYgBC.js";/* empty css               */class se extends re{constructor(){super(...arguments);C(this,"path","admin/banners");C(this,"hasFiles",!0)}}const d=new se,oe=({sections:s,positions:o,sectionPositions:l,multipleAllowedPositions:h})=>{const u=i.useRef(),g=i.useRef(),j=i.useRef(),v=i.useRef(),R=i.useRef(),f=i.useRef(),w=i.useRef(),k=i.useRef(),B=i.useRef(),a=i.useRef(),S=i.useRef(),[A,_]=i.useState(!1),[P,y]=i.useState("home"),[L,D]=i.useState(l.home||{}),U=e=>{y(e);const n=l[e]||{};D(n);const r=Object.keys(n)[0];a.current&&(a.current.value=r||"",$(a.current).trigger("change"))},I=e=>{e!=null&&e.id?_(!0):_(!1);const n=(e==null?void 0:e.section)??"home",r=(e==null?void 0:e.position)??Object.keys(l[n]||{})[0];y(n),D(l[n]||{}),j.current.value=(e==null?void 0:e.id)??"",v.current.value=(e==null?void 0:e.name)??"",R.current.value=(e==null?void 0:e.description)??"",f.image.src=`/api/banners/media/${e==null?void 0:e.image}`,f.current.value=null,w.current.value=(e==null?void 0:e.button_text)??"",k.current.value=(e==null?void 0:e.button_link)??"",B.current.value=n,a.current.value=r,S.current.value=(e==null?void 0:e.order)??0,$(g.current).modal("show")},z=async e=>{e.preventDefault();try{const n=B.current.value,r=a.current.value,c=j.current.value;let m=h.includes(r);if(r==="cambia_empresas"&&n!=="home"&&(m=!1),!m&&((await d.paginate({skip:0,take:1e3})).data||[]).find(F=>F.section===n&&F.position===r&&F.id!=c)){x.fire({icon:"warning",title:"Banner duplicado",text:`Ya existe un banner para la sección "${s[n]}" en la posición "${l[n][r]}". Solo se permite un banner por posición para esta ubicación.`,confirmButtonText:"Entendido"});return}const M={id:c||void 0,name:v.current.value,description:R.current.value,button_text:w.current.value,button_link:k.current.value,section:n,position:r,order:parseInt(S.current.value)||0},N=new FormData;for(const T in M)N.append(T,M[T]);const G=f.current.files[0];G&&N.append("image",G);const O=await d.save(N);if(console.log(O),!O)return;console.log("Refrescando tabla..."),$(u.current).dxDataGrid("instance").refresh(),console.log("Cerrando modal..."),$(g.current).modal("hide")}catch(n){console.error("Error al enviar el formulario:",n),n.message&&n.message.includes("Ya existe un banner")?x.fire({icon:"warning",title:"Banner duplicado",text:n.message,confirmButtonText:"Entendido"}):x.fire({icon:"error",title:"Error",text:"Hubo un error al enviar el formulario. Por favor, inténtalo de nuevo."})}},V=async({id:e,value:n})=>{await d.boolean({id:e,field:"visible",value:n})&&$(u.current).dxDataGrid("instance").refresh()},Y=async e=>{const{isConfirmed:n}=await x.fire({title:"Eliminar banner",text:"¿Estás seguro de eliminar este banner?",icon:"warning",showCancelButton:!0,confirmButtonText:"Sí, eliminar",cancelButtonText:"Cancelar"});!n||!await d.delete(e)||$(u.current).dxDataGrid("instance").refresh()};return t.jsxs(t.Fragment,{children:[t.jsx(Z,{gridRef:u,title:"Banners",rest:d,toolBar:e=>{e.unshift({widget:"dxButton",location:"after",options:{icon:"refresh",hint:"Refrescar tabla",onClick:()=>$(u.current).dxDataGrid("instance").refresh()}}),e.unshift({widget:"dxButton",location:"after",options:{icon:"plus",text:"Nuevo banner",hint:"Nuevo banner",onClick:()=>I()}})},columns:[{dataField:"id",caption:"ID",visible:!1},{dataField:"image",caption:"Imagen",width:"80px",allowFiltering:!1,cellTemplate:(e,{data:n})=>{E(e,t.jsx("img",{src:`/api/banners/media/${n.image}`,style:{width:"70px",height:"40px",objectFit:"cover",objectPosition:"center",borderRadius:"4px"}}))}},{dataField:"name",caption:"Contenido",width:"40%",cellTemplate:(e,{data:n})=>{E(e,t.jsxs("div",{children:[t.jsx("p",{className:"mb-1",children:t.jsx("b",{children:n.name})}),n.description&&t.jsx("small",{className:"text-wrap text-muted",style:{overflow:"hidden",display:"-webkit-box",WebkitBoxOrient:"vertical",WebkitLineClamp:2},children:n.description}),n.button_text&&t.jsx("div",{className:"mt-1",children:t.jsx("small",{className:"badge badge-info",children:n.button_text})})]}))}},{dataField:"section",caption:"Sección",width:"120px",cellTemplate:(e,{data:n})=>{const r=s[n.section]||n.section;e.html(p(t.jsx("span",{className:"badge text-black badge-primary",children:r})))}},{dataField:"position",caption:"Posición",width:"150px",cellTemplate:(e,{data:n})=>{const c=(l[n.section]||{})[n.position]||n.position;let m=h.includes(n.position);n.position==="cambia_empresas"&&n.section!=="home"&&(m=!1),e.html(p(t.jsxs("div",{children:[t.jsx("span",{className:"badge text-black badge-secondary",children:c}),t.jsx("br",{}),t.jsx("small",{className:`text-${m?"success":"warning"}`,children:m?"Múltiples permitidos":"Solo uno permitido"})]})))}},{dataField:"order",caption:"Orden",width:"80px",dataType:"number"},{dataField:"button_link",caption:"Enlace/Mensaje",cellTemplate:(e,{data:n})=>{n.button_link?(()=>{try{const c=new URL(n.button_link);return c.protocol==="http:"||c.protocol==="https:"}catch{return!1}})()?e.html(p(t.jsxs("div",{children:[t.jsx("span",{className:"badge badge-info",children:"Enlace externo"}),t.jsx("br",{}),t.jsx("small",{className:"text-muted text-truncate d-block",style:{maxWidth:"200px"},children:n.button_link})]}))):e.html(p(t.jsxs("div",{children:[t.jsx("span",{className:"badge badge-success",children:"Mensaje WhatsApp"}),t.jsx("br",{}),t.jsx("small",{className:"text-muted",children:n.button_link.length>30?n.button_link.substring(0,30)+"...":n.button_link})]}))):e.html(p(t.jsx("span",{className:"text-muted",children:"Sin configurar"})))}},{dataField:"visible",caption:"Visible",dataType:"boolean",width:"120px",cellTemplate:(e,{data:n})=>{E(e,t.jsx(ne,{checked:n.visible,onChange:r=>V({id:n.id,value:r.target.checked})}))}},{caption:"Acciones",cellTemplate:(e,{data:n})=>{e.css("text-overflow","unset"),e.append(W({className:"btn btn-xs btn-soft-primary",title:"Editar",icon:"fa fa-pen",onClick:()=>I(n)})),e.append(W({className:"btn btn-xs btn-soft-danger",title:"Eliminar",icon:"fa fa-trash",onClick:()=>Y(n.id)}))},allowFiltering:!1,allowExporting:!1}]}),t.jsx(ee,{modalRef:g,title:A?"Editar banner":"Agregar banner",onSubmit:z,size:"lg",children:t.jsxs("div",{className:"row",id:"form-banner",children:[t.jsx("input",{ref:j,type:"hidden"}),t.jsx(te,{eRef:f,label:"Imagen del banner",col:"col-md-4",aspect:2.5,fit:"cover",required:!0}),t.jsxs("div",{className:"col-md-8",children:[t.jsx(b,{eRef:v,label:"Título del banner",required:!0}),t.jsx(ie,{eRef:R,label:"Descripción",rows:2}),t.jsxs("div",{className:"row",children:[t.jsx(b,{eRef:w,label:"Texto del botón",col:"col-md-12"}),t.jsx(b,{eRef:k,label:"Enlace personalizado o mensaje de WhatsApp",col:"col-md-12",placeholder:"https://ejemplo.com o mensaje personalizado",help:"Ingrese una URL (https://...) para enlace externo o un mensaje para WhatsApp"})]})]}),t.jsx(q,{eRef:B,label:"Sección",col:"col-md-4",required:!0,dropdownParent:"#form-banner",onChange:e=>U(e.target.value),children:Object.entries(s).map(([e,n])=>t.jsx("option",{value:e,children:n},e))}),t.jsx(q,{eRef:a,label:"Posición",col:"col-md-4",required:!0,dropdownParent:"#form-banner",children:Object.entries(L).map(([e,n])=>{let r=h.includes(e);return e==="cambia_empresas"&&P!=="home"&&(r=!1),t.jsxs("option",{value:e,children:[n,r?" (Múltiples permitidos)":" (Solo uno)"]},e)})}),t.jsx(b,{eRef:S,label:"Orden",type:"number",col:"col-md-4",defaultValue:0})]})})]})};X((s,o)=>{K(s).render(t.jsx(Q,{...o,title:"Banners",children:t.jsx(oe,{...o})}))});
